<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ポケモン図鑑番号検定</title>
<style>
body { font-family: system-ui, sans-serif; margin:0; padding:10px; background:#f5f5f5; }
.container { max-width:500px; margin:auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
h1 { text-align:center; font-size:1.4em; margin-bottom:10px; }
select, input, button { width:100%; font-size:1.1em; padding:10px; margin:8px 0; }
#status { text-align:center; font-size:1.1em; margin:10px 0; }
#timer { font-weight:bold; color:red; }
.hidden { display:none; }
.gen-container { display:grid; grid-template-columns:1fr 1fr; gap:5px; margin:10px 0; border:1px solid #ccc; padding:5px; border-radius:5px; }
.gen-container label { position:relative; padding-left:5px; display:block; height:25px; line-height:25px; }
.gen-container input[type="checkbox"] { position:absolute; top:0; right:0; transform:scale(1.2); }
.gen-note { font-size:0.9em; color:#555; margin-bottom:10px; }
#message { margin:10px 0; white-space:pre-wrap; font-size:1.05em; }
</style>
</head>
<body>
<div class="container">
<h1>ポケモン図鑑番号検定</h1>

<label>モード選択</label>
<select id="modeSelect">
  <option value="num2poke" selected>番号→ポケモン</option>
  <option value="poke2num">ポケモン→番号</option>
</select>

<label>ルール選択</label>
<select id="ruleSelect">
  <option value="endless" selected>エンドレス</option>
  <option value="timeattack">タイムアタック</option>
</select>

<div id="timeWrapper">
　<label>制限時間選択</label>
　<select id="timeSelect">
　  <option value="0">制限時間なし</option>
 　 <option value="3">3秒</option>
　  <option value="5">5秒</option>
　  <option value="10">10秒</option>
 　 <option value="20">20秒</option>
　  <option value="30" selected>30秒</option>
　  <option value="45">45秒</option>
 　 <option value="60">60秒</option>
　</select>
</div>

<label>世代選択</label>
<div class="gen-container">
  <label><input type="checkbox" value="all" checked> 全て</label>
  <label><input type="checkbox" value="kanto" checked> カントー</label>
  <label><input type="checkbox" value="johto" checked> ジョウト</label>
  <label><input type="checkbox" value="hoenn" checked> ホウエン</label>
  <label><input type="checkbox" value="sinnoh" checked> シンオウ</label>
  <label><input type="checkbox" value="unova" checked> イッシュ</label>
  <label><input type="checkbox" value="kalos" checked> カロス</label>
  <label><input type="checkbox" value="alola" checked> アローラ</label>
  <label><input type="checkbox" value="galar" checked> ガラル</label>
  <label><input type="checkbox" value="paldea" checked> パルデア</label>
</div>
<div class="gen-note">※メルタン→アローラ　ヒスイ→ガラル</div>

<div id="bestContainer">
  この時間の最高記録（1位～3位）：<span id="best">0</span>
</div>

<div id="message"></div>
<button onclick="startGame()">ゲーム開始</button>

<div id="game" class="hidden">
  <div id="status">
    出題：<span id="number"></span><br>
    ⏱ <span id="timer"></span><br>
    正解数：<span id="score">0</span>
  </div>

  <input id="answer" placeholder="答えを入力" autocomplete="off">
  <button onclick="checkAnswer()">判定</button>
  <button onclick="giveUp()">ギブアップ</button>
</div>
</div>

<script>
let pokemon = {};
let numbers = [];
let currentNumber = null;
let timer = null;
let timeLeft = 0;
let limit = 30;
let score = 0;
let elapsed = 0;
let attackTimer = null;

const answer = document.getElementById("answer");
const timeSelect = document.getElementById("timeSelect");
const bestContainer = document.getElementById("bestContainer");
const modeSelect = document.getElementById("modeSelect");
const ruleSelect = document.getElementById("ruleSelect");
const genCheckboxes = document.querySelectorAll(".gen-container input[type='checkbox']");
const messageDiv = document.getElementById("message");
timeSelect.addEventListener("change", () => {
  limit = Number(timeSelect.value);
  updateBest();
});
ruleSelect.addEventListener("change", () => {
  if (ruleSelect.value === "timeattack") {
    document.getElementById("timeWrapper").classList.add("hidden");
    limit = 0;
  } else {
    document.getElementById("timeWrapper").classList.remove("hidden");
    limit = Number(timeSelect.value);
  }
  updateBest();
});

// 日本語正規化
function normalizeJP(str){
  return str.normalize("NFKC").replace(/[\u3041-\u3096]/g, ch=>String.fromCharCode(ch.charCodeAt(0)+0x60));
}

// 世代範囲
const genRanges = {
  kanto:[1,151], johto:[152,251], hoenn:[252,386], sinnoh:[387,493],
  unova:[494,649], kalos:[650,721], alola:[722,809], galar:[810,906], paldea:[907,1025]
};

// 選択世代番号取得
function getSelectedNumbers(){
  const allCb = Array.from(genCheckboxes).find(c => c.value === "all");
  let selected = [];

  // 「全て」がONなら全世代
  if (allCb.checked) {
    Object.values(genRanges).forEach(([s, e]) => {
      for (let i = s; i <= e; i++) selected.push(i);
    });
    return { nums: selected, allChecked: true };
  }

  // 個別世代
  let anyChecked = false;
  genCheckboxes.forEach(cb => {
    if (cb.value !== "all" && cb.checked) {
      anyChecked = true;
      const [s, e] = genRanges[cb.value];
      for (let i = s; i <= e; i++) selected.push(i);
    }
  });

  return { nums: selected, allChecked: false && anyChecked };
}

function bestKey(){ return `pokemon_best_${modeSelect.value}_${limit}`; }

// JSON読み込み
fetch("pokemon.json").then(r=>r.json()).then(data=>{
  pokemon=data;
  numbers=Object.keys(pokemon).map(Number);
  updateBest();
}).catch(()=>alert("pokemon.json の読み込みに失敗しました"));

function updateBest(){
  const {allChecked} = getSelectedNumbers();
  if(!allChecked){bestContainer.style.display="none"; return;}
  bestContainer.style.display="block";
  const bests=JSON.parse(localStorage.getItem(bestKey())||"[0,0,0]");
  bestContainer.querySelector("#best").textContent=bests.join(" / ");
}

// 世代チェックトグル
genCheckboxes.forEach(cb => cb.addEventListener("change", () => {
  const allCb = Array.from(genCheckboxes).find(c => c.value === "all");

  // ===== タイムアタック =====
  if (ruleSelect.value === "timeattack") {

    if (cb.value === "all") {
      // 全て → 全部ON
      genCheckboxes.forEach(c => c.checked = true);
    } else {
      // 個別 → その1つだけ
      genCheckboxes.forEach(c => {
        c.checked = (c === cb);
      });
    }

  // ===== エンドレス =====
  } else {

    if (cb.value === "all") {
      const anyChecked = genCheckboxes.some(
        c => c.value !== "all" && c.checked
      );

      if (anyChecked) {
        // どこか選ばれている → 全解除
        genCheckboxes.forEach(c => c.checked = false);
      } else {
        // 何も選ばれていない → 全選択
        genCheckboxes.forEach(c => c.checked = true);
      }

    } else {
      // 個別操作時：all は外す
      allCb.checked = false;
    }
  }

  updateBest();
}));

// ゲーム開始
function startGame(){
  score = 0;
  elapsed = 0;

  document.getElementById("score").textContent = score;
  document.getElementById("game").classList.remove("hidden");
  messageDiv.textContent = "";

  clearInterval(timer);
  clearInterval(attackTimer);

  if (ruleSelect.value === "timeattack") {
    // タイムアタック：1秒から計測
    document.getElementById("timer").textContent = "0";
    attackTimer = setInterval(() => {
      elapsed++;
      document.getElementById("timer").textContent = elapsed;
    }, 1000);
  } else {
    // エンドレス
    limit = Number(timeSelect.value);
  }

  nextQuestion();
}

// 次の問題
function nextQuestion(){
  clearInterval(timer);
  const {nums} = getSelectedNumbers();
  if(nums.length===0){ alert("世代を選択してください"); return; }

  if (ruleSelect.value === "endless") {
  if(limit===0){
    document.getElementById("timer").textContent="∞";
  } else{
    timeLeft = limit;
    document.getElementById("timer").textContent = timeLeft;
    timer = setInterval(()=>{
      timeLeft--;
      document.getElementById("timer").textContent = timeLeft;
      if(timeLeft<=0) gameOver("時間切れ！");
    },1000);
  }
}

  currentNumber=nums[Math.floor(Math.random()*nums.length)];
  document.getElementById("number").textContent = modeSelect.value==="num2poke"?currentNumber:pokemon[currentNumber];
  answer.value="";
  answer.focus();
}

// Enter判定
answer.addEventListener("keydown", e=>{ if(e.key==="Enter") checkAnswer(); });

// 判定
function checkAnswer(){
  clearInterval(timer);
  const input = normalizeJP(answer.value.trim());
  const correct = modeSelect.value==="num2poke"?normalizeJP(pokemon[currentNumber]):String(currentNumber);
  if(input===correct){
    score++;
    document.getElementById("score").textContent = score;
    nextQuestion();
  } else{
    gameOver("不正解！");
  }
}

// ギブアップ
function giveUp(){ gameOver("ギブアップ！"); }

// ゲームオーバー
function gameOver(reason){
  clearInterval(timer);
  clearInterval(attackTimer);
  const {allChecked} = getSelectedNumbers();
  let bests=[0,0,0];
  if(allChecked){
    bests=JSON.parse(localStorage.getItem(bestKey())||"[0,0,0]");
    if(score>bests[0]){bests=[score,bests[0],bests[1]];}
    else if(score>bests[1]){bests=[bests[0],score,bests[1]];}
    else if(score>bests[2]){bests[2]=score;}
    localStorage.setItem(bestKey(), JSON.stringify(bests));
  }

  const correctAnswer = modeSelect.value==="num2poke"?pokemon[currentNumber]:currentNumber;
  let msg = reason + "\nスコア：" + score + "\n答えは「" + correctAnswer + "」";
  if(allChecked) msg += "\n最高記録：" + bests.join(" / ");

  messageDiv.textContent = msg;
  updateBest();
  document.getElementById("game").classList.add("hidden");
}
</script>
</body>
</html>

