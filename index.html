<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒã‚±ãƒ¢ãƒ³å›³é‘‘ç•ªå·æ¤œå®š</title>
<style>
body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 10px;
    background: #f5f5f5;
}

.container {
    max-width: 500px;
    margin: auto;
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

h1 {
    text-align: center;
    font-size: 1.4em;
    margin-bottom: 10px;
}

select, input, button {
    width: 100%;
    font-size: 1.1em;
    padding: 10px;
    margin: 8px 0;
}

#status {
    text-align: center;
    font-size: 1.1em;
    margin: 10px 0;
}

#timer {
    font-weight: bold;
    color: red;
}

.hidden {
    display: none;
}

.gen-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px;
    margin: 10px 0;
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 5px;
}

.gen-container label {
    position: relative;
    padding-left: 5px;
    display: block;
    height: 25px;
    line-height: 25px;
}

.gen-container input[type="checkbox"] {
    position: absolute;
    top: 0;
    right: 0;
    transform: scale(1.2);
}

.gen-note {
    font-size: 0.9em;
    color: #555;
    margin-bottom: 10px;
}

#message {
    margin: 10px 0;
    white-space: pre-wrap;
    font-size: 1.05em;
}
</style>
</head>
<body>

<div class="container">

<h1>ãƒã‚±ãƒ¢ãƒ³å›³é‘‘ç•ªå·æ¤œå®š</h1>

<label>ãƒ¢ãƒ¼ãƒ‰é¸æŠ</label>
<select id="modeSelect">
    <option value="num2poke" selected>ç•ªå·â†’ãƒã‚±ãƒ¢ãƒ³</option>
    <option value="poke2num">ãƒã‚±ãƒ¢ãƒ³â†’ç•ªå·</option>
</select>

<label>ãƒ«ãƒ¼ãƒ«é¸æŠ</label>
<select id="ruleSelect">
    <option value="endless" selected>ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹</option>
    <option value="timeattack">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</option>
</select>

<div id="timeWrapper">
    <label>åˆ¶é™æ™‚é–“é¸æŠ</label>
    <select id="timeSelect">
        <option value="0">åˆ¶é™æ™‚é–“ãªã—</option>
        <option value="3">3ç§’</option>
        <option value="5" selected>5ç§’</option>
        <option value="10">10ç§’</option>
        <option value="20">20ç§’</option>
        <option value="30">30ç§’</option>
        <option value="45">45ç§’</option>
        <option value="60">60ç§’</option>
    </select>
</div>

<label>ä¸–ä»£é¸æŠ</label>
<div class="gen-container">
    <label><input type="checkbox" value="all" checked> å…¨ã¦</label>
    <label><input type="checkbox" value="kanto" checked> ã‚«ãƒ³ãƒˆãƒ¼</label>
    <label><input type="checkbox" value="johto" checked> ã‚¸ãƒ§ã‚¦ãƒˆ</label>
    <label><input type="checkbox" value="hoenn" checked> ãƒ›ã‚¦ã‚¨ãƒ³</label>
    <label><input type="checkbox" value="sinnoh" checked> ã‚·ãƒ³ã‚ªã‚¦</label>
    <label><input type="checkbox" value="unova" checked> ã‚¤ãƒƒã‚·ãƒ¥</label>
    <label><input type="checkbox" value="kalos" checked> ã‚«ãƒ­ã‚¹</label>
    <label><input type="checkbox" value="alola" checked> ã‚¢ãƒ­ãƒ¼ãƒ©</label>
    <label><input type="checkbox" value="galar" checked> ã‚¬ãƒ©ãƒ«</label>
    <label><input type="checkbox" value="paldea" checked> ãƒ‘ãƒ«ãƒ‡ã‚¢</label>
</div>
<div class="gen-note">â€»ãƒ¡ãƒ«ã‚¿ãƒ³â†’ã‚¢ãƒ­ãƒ¼ãƒ©ã€€ãƒ’ã‚¹ã‚¤â†’ã‚¬ãƒ©ãƒ«</div>

<div id="bestContainer">
    <div id="bestTitle"></div>
    <div id="bestBody"></div>
</div>

<div id="message"></div>

<button onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>

<div id="game" class="hidden">
    <div id="status">
        å‡ºé¡Œï¼š<span id="number"></span><br>
        â± <span id="timer"></span><br>
        æ­£è§£æ•°ï¼š<span id="score">0</span>
    </div>

    <input id="answer" placeholder="ç­”ãˆã‚’å…¥åŠ›" autocomplete="off">
    <button onclick="checkAnswer()" style="padding:24px 10px;">åˆ¤å®š</button>
</div>

</div>

<script>
// ======================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ======================
function formatHMS_Game(sec) {
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return h === 0 ? `${m}:${String(s).padStart(2,"0")}` : `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function formatHMS_Result(sec) {
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return h === 0 ? `${m}åˆ†${String(s).padStart(2,"0")}ç§’` : `${h}æ™‚é–“${String(m).padStart(2,"0")}åˆ†${String(s).padStart(2,"0")}ç§’`;
}

function normalizeJP(str) {
    return str.normalize("NFKC").replace(/[\u3041-\u3096]/g, ch => String.fromCharCode(ch.charCodeAt(0) + 0x60));
}

// ======================
// å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿
// ======================
const genRanges = {
    kanto:[1,151], johto:[152,251], hoenn:[252,386], sinnoh:[387,493],
    unova:[494,649], kalos:[650,721], alola:[722,809], galar:[810,905], paldea:[906,1025]
};

let pokemon = {};
let numbers = [];
let currentNumber = null;
let timer = null;
let attackTimer = null;
let timeLeft = 0;
let limit = 5;
let score = 0;
let elapsed = 0;
let attackPool = [];
let totalQuestions = 0;
let isPlaying = false;
let isNewRecord = false;
const DATA_VERSION = 1;

// ======================
// DOM
// ======================
const answer = document.getElementById("answer");
const timeSelect = document.getElementById("timeSelect");
const bestContainer = document.getElementById("bestContainer");
const modeSelect = document.getElementById("modeSelect");
const ruleSelect = document.getElementById("ruleSelect");
const genCheckboxes = document.querySelectorAll(".gen-container input[type='checkbox']");
const messageDiv = document.getElementById("message");

// ======================
// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œ
// ======================
function loadAttackData(key) {
    try {
        const raw = localStorage.getItem(key);
        if(!raw) return { score:0, time:0, clears:0 };
        const d = JSON.parse(raw);
        return { score:Number(d.score)||0, time:Number(d.time)||0, clears:Number(d.clears)||0 };
    } catch {
        return { score:0, time:0, clears:0 };
    }
}

function saveAttackData(key, data) {
    const safe = {
        version: DATA_VERSION,
        score: Math.max(0, data.score||0),
        time: Math.max(0, data.time||0),
        clears: Math.max(0, data.clears||0)
    };
    localStorage.setItem(key, JSON.stringify(safe));
}

// ======================
// ä¸–ä»£ãƒ»é¸æŠç•ªå·å–å¾—
// ======================
function getSelectedNumbers() {
    let selected = [];
    let allChecked = true;

    genCheckboxes.forEach(cb => {
        if(cb.value !== "all") {
            if(cb.checked) {
                const [s,e] = genRanges[cb.value];
                for(let i=s; i<=e; i++) selected.push(i);
            } else {
                allChecked = false;
            }
        }
    });

    if(allChecked) {
        selected = [];
        Object.values(genRanges).forEach(([s,e]) => {
            for(let i=s; i<=e; i++) selected.push(i);
        });
    }

    return { nums:selected, allChecked };
}

function getSelectedGenInfo() {
    const checked = [...genCheckboxes].filter(c => c.checked && c.value !== "all");

    if(checked.length === 0 || checked.length === Object.keys(genRanges).length) {
        return { name:"å…¨ã¦", max:1025 };
    }

    if(checked.length === 1) {
        const v = checked[0].value;
        const [s,e] = genRanges[v];
        const names = {
            kanto:"ã‚«ãƒ³ãƒˆãƒ¼", johto:"ã‚¸ãƒ§ã‚¦ãƒˆ", hoenn:"ãƒ›ã‚¦ã‚¨ãƒ³", sinnoh:"ã‚·ãƒ³ã‚ªã‚¦",
            unova:"ã‚¤ãƒƒã‚·ãƒ¥", kalos:"ã‚«ãƒ­ã‚¹", alola:"ã‚¢ãƒ­ãƒ¼ãƒ©", galar:"ã‚¬ãƒ©ãƒ«", paldea:"ãƒ‘ãƒ«ãƒ‡ã‚¢"
        };
        return { name: names[v], max: e-s+1 };
    }

    let max = 0;
    checked.forEach(c => { const [s,e] = genRanges[c.value]; max += e-s+1; });
    return { name:"è¤‡æ•°ä¸–ä»£", max };
}

// ======================
// ã‚­ãƒ¼ä½œæˆ
// ======================
function bestKey() { return `pokemon_best_${modeSelect.value}_${limit}_${getSelectedGenInfo().name}`; }
function attackKey() { return `pokemon_attack_${modeSelect.value}_${getSelectedGenInfo().name}`; }

// ======================
// JSONèª­ã¿è¾¼ã¿
// ======================
fetch("pokemon.json")
    .then(r => r.json())
    .then(data => {
        pokemon = data;
        numbers = Object.keys(pokemon).map(Number);
        updateBest();
    })
    .catch(()=>alert("pokemon.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));

// ======================
// æœ€é«˜è¨˜éŒ²æ›´æ–°
// ======================
function updateBest() {
    const rule = ruleSelect.value;
    const { allChecked } = getSelectedNumbers();
    bestContainer.style.display = (rule==="endless" && !allChecked) ? "none" : "block";

    if(rule==="endless") {
        document.getElementById("bestTitle").textContent = "ã“ã®æ™‚é–“ã®æœ€é«˜è¨˜éŒ²ï¼ˆ1ä½ï½3ä½ï¼‰";
        const bests = JSON.parse(localStorage.getItem(bestKey()) || "[0,0,0]");
        document.getElementById("bestBody").textContent = bests.join(" / ");
        return;
    }

    const info = getSelectedGenInfo();
    const key = attackKey();
    const data = loadAttackData(key);
    const crown = data.clears > 0 ? " ğŸ‘‘" : "";
    document.getElementById("bestTitle").textContent = `${info.name}ã®æœ€é«˜è¨˜éŒ²${crown}`;

    let body = `ã‚¹ã‚³ã‚¢ï¼š${data.score}/${info.max}`;
    if(data.clears > 0) {
        body += `\nã‚¿ã‚¤ãƒ ï¼š${formatHMS_Result(data.time)}`
              + `\nã‚¯ãƒªã‚¢å›æ•°ï¼š${data.clears}`;

        // â˜… å¹³å‡å›ç­”æ™‚é–“è¿½åŠ 
        const avgTime = data.time && data.score ? (data.time / data.score).toFixed(2) : "0.00";
        body += `\nå¹³å‡å›ç­”æ™‚é–“ï¼š${avgTime}ç§’`;
    }

    document.getElementById("bestBody").innerText = body;
}

// ======================
// ã‚²ãƒ¼ãƒ é–‹å§‹
// ======================
function startGame() {
    isPlaying = true;
    score = 0;
    elapsed = 0;
    document.getElementById("score").textContent = score;
    document.getElementById("game").classList.remove("hidden");
    messageDiv.textContent = "";

    clearInterval(timer);
    clearInterval(attackTimer);

    const selectedNums = getSelectedNumbers().nums;

    if(ruleSelect.value === "timeattack") {
        attackPool = selectedNums.slice();
        totalQuestions = attackPool.length;
        document.getElementById("timer").textContent = formatHMS_Game(elapsed);

        attackTimer = setInterval(()=>{
            elapsed++;
            document.getElementById("timer").textContent = formatHMS_Game(elapsed);
        },1000);
    } else {
        limit = Number(timeSelect.value);
    }

    nextQuestion();
}

// ======================
// æ¬¡ã®å•é¡Œ
// ======================
function nextQuestion() {
    clearInterval(timer);

    if(ruleSelect.value === "timeattack") {
        if(attackPool.length === 0) {
            gameOver("ğŸ‰ å…¨å•ã‚¯ãƒªã‚¢ï¼");
            return;
        }
        const idx = Math.floor(Math.random() * attackPool.length);
        currentNumber = attackPool.splice(idx,1)[0];
    } else {
        const { nums } = getSelectedNumbers();
        if(nums.length===0){ alert("ä¸–ä»£ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

        if(limit===0) {
            document.getElementById("timer").textContent = "âˆ";
        } else {
            timeLeft = limit;
            document.getElementById("timer").textContent = timeLeft;
            timer = setInterval(()=>{
                timeLeft--;
                document.getElementById("timer").textContent = timeLeft;
                if(timeLeft<=0) gameOver("æ™‚é–“åˆ‡ã‚Œï¼");
            },1000);
        }

        currentNumber = nums[Math.floor(Math.random()*nums.length)];
    }

    const numberEl = document.getElementById("number");
    numberEl.textContent = modeSelect.value==="num2poke"?currentNumber:pokemon[currentNumber];
    numberEl.style.color = modeSelect.value==="num2poke"?"blue":"black";

    answer.value = "";
    answer.focus();
}

// ======================
// åˆ¤å®š
// ======================
answer.addEventListener("keydown", e => { if(e.key==="Enter") checkAnswer(); });

function checkAnswer() {
    clearInterval(timer);
    const input = normalizeJP(answer.value.trim());
    const correct = modeSelect.value==="num2poke"?normalizeJP(pokemon[currentNumber]):String(currentNumber);

    if(input===correct) {
        score++;
        document.getElementById("score").textContent = score;
        nextQuestion();
    } else {
        gameOver("ä¸æ­£è§£ï¼");
    }
}

// ======================
// ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
// ======================
function gameOver(reason) {
    clearInterval(timer);
    clearInterval(attackTimer);

    const { allChecked } = getSelectedNumbers();
    let bests = [0,0,0];

    if(allChecked) {
        bests = JSON.parse(localStorage.getItem(bestKey()) || "[0,0,0]");
        if(score > bests[0]){ bests = [score,bests[0],bests[1]]; }
        else if(score > bests[1]){ bests = [bests[0],score,bests[1]]; }
        else if(score > bests[2]){ bests[2] = score; }
        localStorage.setItem(bestKey(), JSON.stringify(bests));
    }

    if(ruleSelect.value==="timeattack") {
        const key = attackKey();
        const prev = loadAttackData(key);
        const cleared = reason==="ğŸ‰ å…¨å•ã‚¯ãƒªã‚¢ï¼";
        const newScore = Math.max(prev.score, score);
        isNewRecord = false;
        let newTime = prev.time;

        if(cleared && (prev.time===0 || elapsed<prev.time)) {
            newTime = elapsed;
            isNewRecord = true;
        }

        const newClears = prev.clears + (cleared ? 1 : 0);
        saveAttackData(key, { score:newScore, time:newTime, clears:newClears });
    }

    const correctAnswer = modeSelect.value==="num2poke"?pokemon[currentNumber]:currentNumber;
    let msg = "";

    if(reason==="ğŸ‰ å…¨å•ã‚¯ãƒªã‚¢ï¼") {
        const info = getSelectedGenInfo();
        const masterName = info.name==="å…¨ã¦"?"å›³é‘‘ç•ªå·":info.name;
        const avgTime = (elapsed/totalQuestions).toFixed(2);

        msg = `ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼
ã‚ãªãŸã¯${masterName}ãƒã‚¹ã‚¿ãƒ¼ï¼
ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ ï¼š${formatHMS_Result(elapsed)}
å¹³å‡å›ç­”æ™‚é–“ï¼š${avgTime}ç§’`;

        if(isNewRecord) msg += "\nğŸ‰ NEW RECORDï¼";

    } else {
        msg = reason + "\nã‚¹ã‚³ã‚¢ï¼š" + score + "\nç­”ãˆã¯ã€Œ" + correctAnswer + "ã€";
        if(ruleSelect.value==="timeattack") msg += "\nã‚¿ã‚¤ãƒ ï¼š" + formatHMS_Result(elapsed);
    }

    if(ruleSelect.value==="endless" && allChecked) msg += "\næœ€é«˜è¨˜éŒ²ï¼š" + bests.join(" / ");

    messageDiv.textContent = msg;
    updateBest();
    document.getElementById("game").classList.add("hidden");
    isPlaying = false;
}

// ======================
// å¼·åˆ¶çµ‚äº†
// ======================
function forceEndGame() {
    clearInterval(timer);
    clearInterval(attackTimer);
    isPlaying = false;
    document.getElementById("game").classList.add("hidden");
    messageDiv.textContent = "âš  è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸãŸã‚ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸ";
}
</script>

</body>
</html>
